#!/usr/bin/env python3
import sys
import requests
import json
import argparse
import os

def parse_args():
    parser = argparse.ArgumentParser(description="apic - Terminal API Client")
    parser.add_argument("url", help="Target URL")

    # HTTP methods as flags
    parser.add_argument("-g", action="store_true", help="GET request")
    parser.add_argument("-p", action="store_true", help="POST request")
    parser.add_argument("-pu", action="store_true", help="PUT request")
    parser.add_argument("-pa", action="store_true", help="PATCH request")
    parser.add_argument("-d", action="store_true", help="DELETE request")
    parser.add_argument("-h", action="store_true", help="HEAD request")

    # Headers, body, file upload, query
    parser.add_argument("-H", "--header", action="append", help="Custom headers: -H 'Authorization: TOKEN'")
    parser.add_argument("-B", "--body", help="Request body (JSON or raw)")
    parser.add_argument("-F", "--file", action="append", help="File uploads: -F 'field=@file'")
    parser.add_argument("-q", "--query", help="Query params: key=value&key2=value2")

    # Extra options
    parser.add_argument("-o", "--output", help="Save response to file")
    parser.add_argument("-v", "--verbose", action="store_true", help="Verbose output")
    parser.add_argument("-t", type=int, default=10, help="Request timeout in seconds")  # short flag for timeout

    return parser.parse_args()

def main():
    args = parse_args()
    url = args.url

    # Determine HTTP method
    method = "GET"  # default
    if args.g: method = "GET"
    elif args.p: method = "POST"
    elif args.pu: method = "PUT"
    elif args.pa: method = "PATCH"
    elif args.d: method = "DELETE"
    elif args.h: method = "HEAD"

    # Parse headers
    headers = {}
    if args.header:
        for h in args.header:
            if ":" in h:
                k, v = h.split(":", 1)
                headers[k.strip()] = v.strip()

    # Parse query parameters
    params = {}
    if args.query:
        for pair in args.query.split("&"):
            if "=" in pair:
                k, v = pair.split("=", 1)
                params[k] = v

    # Prepare body
    data = None
    json_data = None
    if args.body:
        try:
            json_data = json.loads(args.body)
            headers.setdefault("Content-Type", "application/json")
        except json.JSONDecodeError:
            data = args.body

    # Prepare files for upload
    files = {}
    if args.file:
        for f in args.file:
            if "=" in f:
                field, path = f.split("=",1)
                path = path.strip()
                if path.startswith("@"):
                    path = path[1:]
                if os.path.exists(path):
                    files[field.strip()] = open(path, "rb")
                else:
                    print(f"File not found: {path}")
                    return

    # Make the request
    try:
        response = requests.request(
            method,
            url,
            headers=headers,
            params=params,
            data=data,
            json=json_data,
            files=files if files else None,
            timeout=args.t
        )

        # Close any opened files
        for f in files.values():
            f.close()

        # Verbose output
        if args.verbose:
            print("=== Request ===")
            print(f"{method} {url}")
            print(f"Headers: {headers}")
            if data: print(f"Body: {data}")
            if json_data: print(f"JSON: {json.dumps(json_data, indent=2)}")
            if params: print(f"Query: {params}")
            print("================\n")

        # Status
        print(f"Status: {response.status_code}\n")

        # Save or print response
        if args.output:
            with open(args.output, "w") as f:
                f.write(response.text)
            print(f"Response saved to {args.output}")
        else:
            try:
                print(json.dumps(response.json(), indent=2))
            except Exception:
                print(response.text)

    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    main()
